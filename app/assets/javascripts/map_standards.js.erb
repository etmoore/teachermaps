//////////////////////////////
//
// Add Map Objective to Map Standard
//
//////////////////////////////


$('#create_map_objective').live("click", function(e) {

    var mapStandardId = $('#map_standard_id').val();
    var actionUrl = $(this).attr('action-url');

    console.log("Adding Objective to Map Standard: " + mapStandardId + " via path " + actionUrl);

    if(map_standard_id == undefined || actionUrl == undefined) return false;

    $.ajax({
        data: { 
            'map_standard_id' : mapStandardId
        },
        type: 'POST',
        url: actionUrl,
        dataType: 'html',
        success: function (response) {
            $('#map_standards_objectives_list').html(response);
        },
        error: function (xhr, ajaxOptions, thrownError) {
            pushFlash({message:"Error adding a Map Objective", state: 'error', fadeOut: 5000});
        }
    });

    e.stopPropagation();
});

//////////////////////////////
//
// Remove Unit Assessment to Map
//
//////////////////////////////


$(".map_standards_map_objective_destroy")
.live("ajax:error", function(event, data, status, xhr) {
    pushFlash({message:"Error deleting Map Assessment", state: 'error', fadeOut: 5000});
})
.live("ajax:success", function(event, data, status, xhr) {
    $('#map_standards_objectives_list').html(data);
});


$(".maps_objectives_show_resources")
.live("ajax:error", function(event, data, status, xhr) {
    pushFlash({message:"Error fetching Map Objective Resources", state: 'error', fadeOut: 5000});
})
.live("ajax:success", function(event, data, status, xhr) {
    $('#filter_map_objectives_resources_modal').html(data);        
});






//////////////////////////////
//
// Filter Resources for Map Resources
//
//////////////////////////////

var timer;
$("#map_standards_filter_resource_search").live('keyup input',function() {
    var form = $(this);
    // Prevents ajax request till N milliseconds 
    timer && clearTimeout(timer);
    timer = setTimeout(function(){ 
        form.submit();
    }, 500);
});

// Needed for browser compatibility 
$('#map_standards_filter_resource_form').live('change', function() {
    $(this).submit();
});

$("#map_standards_filter_resource_form")
.live("ajax:error", function(event, data, status, xhr) {
    pushFlash({message:"<%= I18n.t('resources.filter_failure') %>", state: 'success', fadeOut: 5000});
})
.live("ajax:success", function(event, data, status, xhr) {
    // Update the resources table
    $("#map_standards_resources_table").html(data);  
});

//////////////////////////////
//
// Adding/Removing Map Standards
//
//////////////////////////////


$('#map_standards_resources_table .map_objectives_resource_selected').live("click", function(e) {

    // /map_objectives/:map_objective_id/resource/:map_resource_id/destroy
    var mapObjectiveId = $(this).attr('map-objective-id');
    var resourceId = $(this).attr('resource-id'); 
    var actionUrl = '/map_objectives/'+mapObjectiveId+'/resources/'+resourceId+'/destroy'
    var resourceElem = $(this);

    console.log("Removing map resource from objective: "+actionUrl)

    if(mapObjectiveId == undefined || resourceId == undefined) return false;

    $.ajax({
        url: actionUrl,
        dataType: 'html',
        success: function (response) {
            console.log("Removed map resource to assessment: "+actionUrl)
            $('#map_standards_objectives_list').html(response);

            resourceElem.attr('class','map_objectives_resource_default');
        },
        error: function (xhr, ajaxOptions, thrownError) {
            pushFlash({message:"Error removing resource to Map Objective", state: 'error', fadeOut: 5000});
        }
    });  

    e.stopPropagation();
});

$('#map_standards_resources_table .map_objectives_resource_default').live("click", function(e) {
    
    // /map_objectives/:map_objective_id/resource/:map_resource_id/new
    var mapObjectiveId = $(this).attr('map-objective-id');
    var resourceId = $(this).attr('resource-id'); 
    var actionUrl = '/map_objectives/'+mapObjectiveId+'/resources/'+resourceId+'/new'
    var resourceElem = $(this);

    console.log("Removing map resource from Map Objective: "+actionUrl)

    if(mapObjectiveId == undefined || resourceId == undefined) return false;

    $.ajax({
        url: actionUrl,
        dataType: 'html',
        success: function (response) {
            console.log("Added map resource to assessment: "+actionUrl)
            $('#map_standards_objectives_list').html(response);

            resourceElem.attr('class','map_objectives_resource_selected');
        },
        error: function (xhr, ajaxOptions, thrownError) {
            pushFlash({message:"Error adding resource to Map Objective", state: 'error', fadeOut: 5000});
        }
    });   
    
    e.stopPropagation();
});
