$(document).ready(function() {
  /* Activating Best In Place */
  jQuery(".best_in_place").best_in_place();
});

jQuery(function($) {    

    $('#maps_table tr').live("click", function(e) {
    
        var mapURI = $(this).attr('map-url');
        window.location = mapURI;
        return;
    });


    //////////////////////////////
    //
    // Filter Resources for Map
    //
    //////////////////////////////

    var timer;
    $("#maps_filter_resource_search").live('keyup input',function() {
        var form = $(this);
        // Prevents ajax request till N milliseconds 
        timer && clearTimeout(timer);
        timer = setTimeout(function(){ 
            form.submit();
        }, 500);
    });

    // Needed for browser compatibility 
    $('#maps_filter_resource_form').live('change', function() {
        $(this).submit();
    });

    $("#maps_filter_resource_form")
    .live("ajax:error", function(event, data, status, xhr) {
        pushFlash({message:"<%= I18n.t('resources.filter_failure') %>", state: 'success', fadeOut: 5000});
    })
    .live("ajax:success", function(event, data, status, xhr) {
        // Update the resources table
        $("#maps_resources_table").html(data);  
    });


    //////////////////////////////
    //
    // Add Unit Assessment to Map
    //
    //////////////////////////////


    $('#create_map_assessment').live("click", function(e) {

        var userId = $('#user-id').val();
        var mapId = $('#map-id').val();
        var actionUrl = $(this).attr('action-url');

        if(userId == undefined || mapId == undefined || actionUrl == undefined) return false;

        // console.log("Adding assessment to Map: " + mapId + " owned by " + userId + " via path " + actionUrl);

        $.ajax({
            data: { 
                'map_assessment': { 'user_id' : userId, 'map_id' : mapId }
            },
            type: 'POST',
            url: actionUrl,
            dataType: 'html',
            success: function (response) {
                $('#maps_list_map_assessments').html(response);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                pushFlash({message:"Error adding a Map Assessment", state: 'error', fadeOut: 5000});
            }
        });

        e.stopPropagation();
    });

    //////////////////////////////
    //
    // Remove Unit Assessment to Map
    //
    //////////////////////////////


    $(".maps_map_assessments_destroy")
    .live("ajax:error", function(event, data, status, xhr) {
        pushFlash({message:"Error deleting Map Assessment", state: 'error', fadeOut: 5000});
    })
    .live("ajax:success", function(event, data, status, xhr) {
        $('#maps_list_map_assessments').html(data);
    });

    $(".maps_map_assessments_show_resources")
    .live("ajax:error", function(event, data, status, xhr) {
        pushFlash({message:"Error fetching Map Assessment resources", state: 'error', fadeOut: 5000});
    })
    .live("ajax:success", function(event, data, status, xhr) {
        $('#filter_map_resources_modal').html(data);        
    });


});