$(document).ready(function(){    

    
    //////////////////////////////
    //
    // Create Resources 
    //
    //////////////////////////////


    $("#create_resource_link_form")
    .on("ajax:error", function(event, data, status, xhr) {
        // Not sure why I have to use the responseText here
        $("#put_resource_link_errors").html(data.responseText);      
    })
    .on("ajax:success", function(event, response, status, xhr) {
        
        data = $.parseJSON(response);

        if (data != undefined) {
            if (data.resources != undefined) {
                $("#resources_table").html(data.resources);
            }
            if (data.filters != undefined) {
                $('#resource_filter').html(data.filters);
            }
        }

        // Flash user of the success
        pushFlash({message:"<%= I18n.t('resources.upload_success') %>", state: 'success', fadeOut: 5000});
        // Hide all modals
        $('.modal.in').modal('hide');   
        // Rest form
        $(this)[0].reset();
        // Clear any error notification
        $("#uploadResourcesErrors").html('');  
        closeModalOnSubmit();
    });






    //////////////////////////////
    //
    // Filter Resources 
    //
    //////////////////////////////

    var timer;
    $("#filter_resource_search").on('keyup input',function() {
        var form = $(this);
        // Prevents ajax request till N milliseconds 
        timer && clearTimeout(timer);
        timer = setTimeout(function(){ 
            form.submit();
        }, 500);
    });

    // Needed for browser compatibility 
    $('#filter_resource_form').on('change', function() {
        $(this).submit();
    });

    $("#filter_resource_form")
    .on("ajax:error", function(event, data, status, xhr) {
        pushFlash({message:"<%= I18n.t('resources.filter_failure') %>", state: 'success', fadeOut: 5000});
    })
    .on("ajax:success", function(event, data, status, xhr) {
        // Update the resources table
        $("#resources_table").html(data);  
    });

    var map_timer;
    $("#maps_filter_resource_form").on('keyup input',function() {
        var form = $(this);
        // Prevents ajax request till N milliseconds 
        timer && clearTimeout(timer);
        timer = setTimeout(function(){ 
            form.submit();
        }, 500);
    });

    // Needed for browser compatibility 
    $('#maps_filter_resource_form').on('change', function() {
        $(this).submit();
    });

    $("#maps_filter_resource_form")
    .on("ajax:error", function(event, data, status, xhr) {
        pushFlash({message:"<%= I18n.t('resources.filter_failure') %>", state: 'success', fadeOut: 5000});
    })
    .on("ajax:success", function(event, data, status, xhr) {
        // Update the resources table
        $("#map_resource_table").html(data);  
    });


    //////////////////////////////
    //
    // Adding/Removing  Resource
    //
    //////////////////////////////


    $('#map_resource_list .resource-selected').on("click", function(e) {

        var standardId = $(this).attr('standard-id');
        var mapId = $('#map-id').attr('map-id');
        if(standardId == undefined || mapId == undefined) return false;

        console.log("Removing Standard from Map: " + standardId + " From Map: " + mapId);

        var requestURL = '/ajax/maps/'+mapId+'/map_standards/'+standardId+'/destroy';

        $.ajax({
          url: requestURL,
          dataType: 'html'
        }).done(function(data) {
          console.log("Removed Standard from Map: " + standardId + " From Map: " + mapId);
          $('#map_standards_list').html(data);
        });   

        $(this).attr('class','standard-default');

        e.stopPropagation();
    });

    $('#map_resource_list .resource-default').on("click", function(e) {
    
        var standardId = $(this).attr('standard-id');
        var mapId = $('#map-id').attr('map-id');
        if(standardId == undefined || mapId == undefined) return false;

        console.log("Adding Standard from Map: " + standardId + " From Map: " + mapId);

        var requestURL = '/ajax/maps/'+mapId+'/map_standards/'+standardId+'/new';

        $.ajax({
          url: requestURL,
          dataType: 'html'
        }).done(function(data) {
          console.log("Added Standard from Map: " + standardId + " From Map: " + mapId);
          $('#map_standards_list').html(data);
        });   

        // Mark all children standards as selected
        $(this).find('.standard-default').each(function() {
            $(this).attr('class','standard-selected');
        });

        $(this).attr('class','standard-selected');

        e.stopPropagation();
    });


    //////////////////////////////
    //
    // Edit Resources 
    //
    //////////////////////////////


    $("#edit_resource_link_form")
    .on("ajax:beforeSend", function(xhr, settings) {
        // Blah!!!
    })
    .on("ajax:error", function(event, data, status, xhr) {
        // Not sure why I have to use the responseText here
        $("#edit_resource_link_errors").html(data.responseText);      
    })
    .on("ajax:success", function(event, data, status, xhr) {
        // Update the resources table
        $("#resources_table").html(data);  
        // Flash user of the success
        pushFlash({message:"<%= I18n.t('resources.edit_success') %>", state: 'success', fadeOut: 5000});
        $("#uploadResourcesErrors").html('');  
        closeModalOnSubmit();
    });

    $("#edit_resource_link_view")
    .on("click", function() {

        var resourceId = $(this).attr('resource-id');
        
        // Confirm form data exists
        if (resourceId == undefined) return false;

        $.ajax({
          url: '/resources/'+resourceId+'/edit',
          dataType: 'html'
        }).done(function(data) {
            $('#edit_resource_link_modal_body').html(data);
            $('#edit_resource_link_modal').modal('show');
            $('#show_resource_link_modal').modal('hide');
        });   

    });







    //////////////////////////////
    //
    // Show Resources 
    //
    //////////////////////////////


    $('#resources_table a').on("click", function(e) {
        e.stopPropagation();
    });

    // This is currently duplicated, will update when we decide
    // weather we are going to click a resource row or click an 
    // edit button. 
    $('#resources_table tr').on("click", function(e) {
    
        var resourceURI = $(this).attr('resource-url');

        if(resourceURI == undefined) return false;
        
        // Confirm form data exists
        if (resourceURI == undefined) return false;

        $.ajax({
          url: resourceURI,
          dataType: 'html'
        }).done(function(data) {
          $('#show_resource_link_modal_body').html(data);
          $('#show_resource_link_modal').modal('show');
        });   

        e.stopPropagation();
    });

    $('.show_resource').on("click", function(e) {
    
        var resourceURI = $(this).attr('resource-url');

        if(resourceURI == undefined) return false;
        
        // Confirm form data exists
        if (resourceURI == undefined) return false;

        $.ajax({
          url: resourceURI,
          dataType: 'html'
        }).done(function(data) {
          $('#show_resource_link_modal_body').html(data);
          $('#show_resource_link_modal').modal('show');
        });   

        e.stopPropagation();
    });
    
});




